<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>vignette</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">vignette</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(blblm)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co">#&gt; ── Attaching packages ────────────────────────────────────────────────────────────────────── tidyverse 1.3.0 ──</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#&gt; ✓ ggplot2 3.3.0     ✓ purrr   0.3.4</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt; ✓ tibble  3.0.0     ✓ dplyr   0.8.5</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt; ✓ tidyr   1.0.2     ✓ stringr 1.4.0</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co">#&gt; ✓ readr   1.3.1     ✓ forcats 0.5.0</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#&gt; ── Conflicts ───────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co">#&gt; x dplyr::filter() masks stats::filter()</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co">#&gt; x dplyr::lag()    masks stats::lag()</span></a></code></pre></div>
<div id="an-overview-of-this-package" class="section level1">
<h1>An Overview of This Package</h1>
<div id="goal" class="section level2">
<h2>Goal:</h2>
<p>This Package is meant for implementing several different linear models with the the Bag of Little Bootstraps (BLB) algorithm, with the option that allowing user to using parallel computation. The function will return the user the coefficient of the model and also the confidence interval generated through bootstrapy apporach. Under the linear context, the model also enable the user to directly fit their functions. By doing so, we hope this package can provide the user a relatively easier way to deal with large dataset.</p>
</div>
<div id="what-and-why-is-blb" class="section level2">
<h2>What and Why is BLB?</h2>
<div id="ideas-behind-the-blb" class="section level3">
<h3>Ideas behind the BLB:</h3>
<p>The Bag of Little Bootstraps algorithm is an attempt to divide the large dataset into smaller subsamples through bootstrap resampling technique and conduct the computation at the micro-level and then take the average of the statistics computated at each level to get an inference of the parameters we hope to get. Given the modern context in which people often needs to handle relatively large dataset, the traditional bootstrap may seems memory and time consuming, as the resampling of large dataset itself will cost many resources. By divding the data into smaller sets and conducting resampling on the smaller levels, the memory and time cost will be lower than conducting the bootstrap directly on the original dataset.</p>
<p>For the detailed information regarding the BLB algorithm, see Ariel Kleiner el 2011 for the first version of the BLB algorithm. This alogrithm, since invented, recieved wide notices and still being developeds. More detailed and recent examples of the application of BLB algorithm includes de Viña el 2018 on BLB in Enseble learning.</p>
</div>
<div id="why-blb" class="section level3">
<h3>Why BLB?</h3>
<p>However, one may well argue that the BLB algorithm is still memory and time consuming than other algorithm such as the tradition divide and conquer strategy. While this is true, BLB algorithm still having some powerful features than other traditional parallel strategies in dealing with the large dataset. The first of all is that it enables the use of the bootstrap in the parallel process. The traditional divide and conquer strategy, in fact, hardly address the situation that the expectation of the probility is unstable and thus make the ability for each subunit to coverge on the original distribution weaker. In stead of directly dividing the data, by introducing resampling strategy during the partition, we can try to simulate the original dataset at the smaller level and thus granttee the robustness of the computation and thus the inference.</p>
</div>
</div>
<div id="the-structure-of-the-package" class="section level2">
<h2>The structure of the package</h2>
<div id="logical-structure" class="section level3">
<h3>Logical Structure</h3>
<p>The package fit the linear model model with the BLB alogrithm by three parts nested inside each of the three linear model this package contain. The first part is the data prepartion which manage the data into proper form and then split the data. The second part is to generate the weights and fit the weighted regression on each subsamples, and the last one is the to compute the coeifficiences of the model in general by summarizing the statistics computed at each mirco-level.</p>
</div>
<div id="file-organization" class="section level3">
<h3>File organization</h3>
<p>This package actually divide the R script by the model used. There are three models contained within this package. The first one is the <code>lm</code> version of regression model, the second one is the <code>glm</code>, a.k.a, the generalized linear model, and the <code>rlm</code>, which refer to the robust linear model introduced by the package <code>MASS</code>, and follows the same ideas of the <code>line</code> functions from the <code>stats</code> package. Each model has a linear version and non-linear version, with the shared first and the third parts nested in <code>lm</code>. <code>glm</code> has its own verision of coeifficences computation.</p>
</div>
</div>
</div>
<div id="explanation-of-the-functions-inside-the-package" class="section level1">
<h1>Explanation of the Functions inside the package</h1>
<div id="the-data-handling-part" class="section level2">
<h2>The data handling part</h2>
<p>These part of the function deals the input data with two goals. Frist of the all, if the user want to only load part of the data under the working directory. Then, the <code>read_list</code> function will load the files matched excatly same name pattern and row_bind them into a new data frame without loading the data as a whole. The function is below. Notice, please assign the working directory to the where the data are located.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">#' @param data The input data</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">read_list &lt;-<span class="st"> </span><span class="cf">function</span>(data) {</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  pattern =<span class="st"> </span><span class="kw">paste0</span>(data, <span class="dt">collapse =</span> <span class="st">&quot;|&quot;</span>) <span class="co"># Translating name into the regExpress</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="co"># Read all files under working directory at once</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">getwd</span>(), <span class="dt">pattern =</span> pattern, <span class="dt">full.names =</span> T) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="st">    </span><span class="kw">map_df</span>(<span class="op">~</span><span class="kw">fread</span>(.))</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  files <span class="co"># Returning the file</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">}</a></code></pre></div>
<p>Second, we want to further split the dataset into given number of the subsample and on which, we will achive the bootstraps. The function is below with an example.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">split_data &lt;-<span class="st"> </span><span class="cf">function</span>(data, m) {</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  idx &lt;-<span class="st"> </span><span class="kw">sample.int</span>(m, <span class="kw">nrow</span>(data), <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">split</span>(idx)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">split_data</span>(mtcars,<span class="dt">m =</span> <span class="dv">10</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Split the data randomly into 10 subsample</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="st">  </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; $`1`</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt;                 mpg cyl  disp  hp drat    wt  qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; Merc 280       19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; Merc 450SL     17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt; Toyota Corolla 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt; Camaro Z28     13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="co">#&gt; $`2`</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt;                mpg cyl  disp  hp drat   wt qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt; Merc 280C     17.8   6 167.6 123 3.92 3.44 18.9  1  0    4    4</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#&gt; Ferrari Dino  19.7   6 145.0 175 3.62 2.77 15.5  0  1    5    6</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">#&gt; Maserati Bora 15.0   8 301.0 335 3.54 3.57 14.6  0  1    5    8</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="co">#&gt; $`4`</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="co">#&gt;                      mpg cyl  disp  hp drat    wt  qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="co">#&gt; Valiant             18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1</span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="co">#&gt; Merc 240D           24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="co">#&gt; Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">#&gt; Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="co">#&gt; Lotus Europa        30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-28" data-line-number="28"><span class="co">#&gt; $`5`</span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29"><span class="co">#&gt;                   mpg cyl disp  hp drat   wt  qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb3-30" data-line-number="30"><span class="co">#&gt; Dodge Challenger 15.5   8  318 150 2.76 3.52 16.87  0  0    3    2</span></a>
<a class="sourceLine" id="cb3-31" data-line-number="31"><span class="co">#&gt; Volvo 142E       21.4   4  121 109 4.11 2.78 18.60  1  1    4    2</span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-33" data-line-number="33"><span class="co">#&gt; $`6`</span></a>
<a class="sourceLine" id="cb3-34" data-line-number="34"><span class="co">#&gt;                    mpg cyl  disp  hp drat    wt  qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35"><span class="co">#&gt; Hornet 4 Drive    21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36"><span class="co">#&gt; Hornet Sportabout 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37"><span class="co">#&gt; Toyota Corona     21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1</span></a>
<a class="sourceLine" id="cb3-38" data-line-number="38"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-39" data-line-number="39"><span class="co">#&gt; $`7`</span></a>
<a class="sourceLine" id="cb3-40" data-line-number="40"><span class="co">#&gt;                     mpg cyl  disp  hp drat    wt  qsec vs am gear carb</span></a>
<a class="sourceLine" id="cb3-41" data-line-number="41"><span class="co">#&gt; Mazda RX4          21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4</span></a>
<a class="sourceLine" id="cb3-42" data-line-number="42"><span class="co">#&gt; Mazda RX4 Wag      21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4</span></a>
<a class="sourceLine" id="cb3-43" data-line-number="43"><span class="co">#&gt; Datsun 710         22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1</span></a>
<a class="sourceLine" id="cb3-44" data-line-number="44"><span class="co">#&gt; Merc 230           22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2</span></a>
<a class="sourceLine" id="cb3-45" data-line-number="45"><span class="co">#&gt; Cadillac Fleetwood 10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4</span></a>
<a class="sourceLine" id="cb3-46" data-line-number="46"><span class="co">#&gt; AMC Javelin        15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2</span></a></code></pre></div>
<p>After spiliting data, we now can conduct the bootstrap at each subsample.</p>
</div>
<div id="the-bootstrap-fitting" class="section level2">
<h2>The bootstrap fitting</h2>
<p>Here we now start to deal with the fitting process. In general, the fitting process we really on is to, firstly, decided the weights of each boot using a multinominal distribution and then using tradition fit techiques to fit the mode and sumarize them up.</p>
<div id="ordinary-linear-model-and-the-robust-linear-modelparallely-and-non-parallely" class="section level3">
<h3>ordinary linear model and the robust linear model(parallely and non-parallely)</h3>
<p>The functional structure for both <code>lm</code> fitting and the <code>rlm</code> fitting are quit simialr, so here we combine them together. We will first need to use the core function to start the bootsrap fitting, with also an parallel verision functions. For parallel part, this package offer both traditional parallel approch and future map approch for <code>lm</code> in separated function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Non-parallel version lm</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">blblm &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, <span class="dt">m =</span> <span class="dv">10</span>, <span class="dt">B =</span> <span class="dv">5000</span>) {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="cf">if</span>(<span class="kw">typeof</span>(data) <span class="op">==</span><span class="st"> &quot;character&quot;</span>){</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    df &lt;-<span class="st"> </span><span class="kw">read_list</span>(data)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">    data_list &lt;-<span class="st"> </span><span class="kw">split_data</span>(df, m)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  <span class="cf">else</span>{</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    data_list &lt;-<span class="st"> </span><span class="kw">split_data</span>(data, m)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">  }</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">  estimates &lt;-<span class="st"> </span><span class="kw">map</span>(</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">    data_list,</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">    <span class="op">~</span><span class="st"> </span><span class="kw">lm_each_subsample</span>(<span class="dt">formula =</span> formula, <span class="dt">data =</span> ., <span class="dt">n =</span> <span class="kw">nrow</span>(data), <span class="dt">B =</span> B))</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  res &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">estimates =</span> estimates, <span class="dt">formula =</span> formula)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  <span class="kw">class</span>(res) &lt;-<span class="st"> &quot;blblm&quot;</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  <span class="kw">invisible</span>(res)</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">}</a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># Parallel version of rlm</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">blblm_robust_parallel &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, <span class="dt">m =</span> <span class="dv">10</span>, <span class="dt">B =</span> <span class="dv">5000</span>, <span class="dt">core =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(core)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  <span class="kw">clusterExport</span>(cl, <span class="kw">c</span>(<span class="st">&quot;lm_robust_each_boot&quot;</span>,<span class="st">&quot;lm1_robust&quot;</span>,<span class="st">&quot;blbcoef&quot;</span>,<span class="st">&quot;blbsigma&quot;</span>))</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="cf">if</span>(<span class="kw">typeof</span>(data) <span class="op">==</span><span class="st"> &quot;character&quot;</span>){</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">    df &lt;-<span class="st"> </span><span class="kw">read_list</span>(data)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    data_list &lt;-<span class="st"> </span><span class="kw">split_data</span>(df, m)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  <span class="cf">else</span>{</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">    data_list &lt;-<span class="st"> </span><span class="kw">split_data</span>(data, m)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">  }</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">  estimates &lt;-<span class="st"> </span><span class="kw">parLapplyLB</span>(cl,</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">                           data_list,</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">                           <span class="dt">chunk.size =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">                           lm_robust_each_subsample,<span class="dt">formula =</span> formula, <span class="dt">n =</span> <span class="kw">nrow</span>(data), <span class="dt">B =</span> B)</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">  <span class="kw">stopCluster</span>(cl)</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">  res &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">estimates =</span> estimates, <span class="dt">formula =</span> formula)</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">  <span class="kw">class</span>(res) &lt;-<span class="st"> &quot;blblm&quot;</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19">  <span class="kw">invisible</span>(res)</a>
<a class="sourceLine" id="cb5-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb5-21" data-line-number="21"></a>
<a class="sourceLine" id="cb5-22" data-line-number="22">blblm_furrr &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, <span class="dt">m =</span> <span class="dv">10</span>, <span class="dt">B =</span> <span class="dv">5000</span>, <span class="dt">core =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">  future<span class="op">::</span><span class="kw">plan</span>(future<span class="op">::</span>multiprocess, <span class="dt">workers =</span> core)</a>
<a class="sourceLine" id="cb5-24" data-line-number="24">  <span class="cf">if</span>(<span class="kw">typeof</span>(data) <span class="op">==</span><span class="st"> &quot;character&quot;</span>){</a>
<a class="sourceLine" id="cb5-25" data-line-number="25">    df &lt;-<span class="st"> </span><span class="kw">read_list</span>(data)</a>
<a class="sourceLine" id="cb5-26" data-line-number="26">    data_list &lt;-<span class="st"> </span><span class="kw">split_data</span>(df, m)</a>
<a class="sourceLine" id="cb5-27" data-line-number="27">  }</a>
<a class="sourceLine" id="cb5-28" data-line-number="28">  <span class="cf">else</span>{</a>
<a class="sourceLine" id="cb5-29" data-line-number="29">    data_list &lt;-<span class="st"> </span><span class="kw">split_data</span>(data, m)</a>
<a class="sourceLine" id="cb5-30" data-line-number="30">  }</a>
<a class="sourceLine" id="cb5-31" data-line-number="31">  estimates &lt;-<span class="st"> </span><span class="kw">future_map</span>(</a>
<a class="sourceLine" id="cb5-32" data-line-number="32">    data_list,</a>
<a class="sourceLine" id="cb5-33" data-line-number="33">    <span class="op">~</span><span class="st"> </span><span class="kw">lm_each_subsample</span>(<span class="dt">formula =</span> formula, <span class="dt">data =</span> ., <span class="dt">n =</span> <span class="kw">nrow</span>(data), <span class="dt">B =</span> B))</a>
<a class="sourceLine" id="cb5-34" data-line-number="34">  res &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">estimates =</span> estimates, <span class="dt">formula =</span> formula)</a>
<a class="sourceLine" id="cb5-35" data-line-number="35">  <span class="kw">class</span>(res) &lt;-<span class="st"> &quot;blblm&quot;</span></a>
<a class="sourceLine" id="cb5-36" data-line-number="36">  <span class="kw">invisible</span>(res)</a>
<a class="sourceLine" id="cb5-37" data-line-number="37">  <span class="kw">closeAllConnections</span>()</a>
<a class="sourceLine" id="cb5-38" data-line-number="38">}</a></code></pre></div>
<p>Here we can see, we simple pass the parameter such as the number of subsamples, the cores we want to use and the times of Bootstrap we wnat to have and let the function to pass the parameter on to the subsample level. Then we will exam the subsample level. As the following function suggest, here we will repeat the really fit boot process for given times.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">lm_each_subsample &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, n, B) {</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="kw">replicate</span>(B, <span class="kw">lm_each_boot</span>(formula, data, n), <span class="dt">simplify =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">}</a></code></pre></div>
<p>Then we will exam what happens at the boot level.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">lm_each_boot &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, n) {</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  freqs &lt;-<span class="st"> </span><span class="kw">rmultinom</span>(<span class="dv">1</span>, n, <span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(data)))</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="kw">lm1</span>(formula, data, freqs)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">lm1 &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, freqs) {</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">  <span class="co"># drop the original closure of formula,</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">  <span class="co"># otherwise the formula will pick a wront variable from the global scope.</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  <span class="kw">environment</span>(formula) &lt;-<span class="st"> </span><span class="kw">environment</span>()</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">  fit &lt;-<span class="st"> </span><span class="kw">lm</span>(formula, data, <span class="dt">weights =</span> freqs)</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">  <span class="kw">list</span>(<span class="dt">coef =</span> <span class="kw">blbcoef</span>(fit), <span class="dt">sigma =</span> <span class="kw">blbsigma</span>(fit))</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">}</a></code></pre></div>
<p>Similarly, for <code>rlm</code> we have</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">lm_robust_each_subsample &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, n, B) {</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="kw">replicate</span>(B, <span class="kw">lm_each_boot</span>(formula, data, n), <span class="dt">simplify =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">lm_robust_each_boot &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, n) {</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  freqs &lt;-<span class="st"> </span><span class="kw">rmultinom</span>(<span class="dv">1</span>, n, <span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(data)))</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  <span class="kw">lm1</span>(formula, data, freqs)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">lm1_robust &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, freqs) {</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">  <span class="co"># drop the original closure of formula,</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">  <span class="co"># otherwise the formula will pick a wront variable from the global scope.</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">  <span class="kw">environment</span>(formula) &lt;-<span class="st"> </span><span class="kw">environment</span>()</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">  fit &lt;-<span class="st"> </span><span class="kw">rlm</span>(formula, data, <span class="dt">weights =</span> freqs)</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">  <span class="kw">list</span>(<span class="dt">coef =</span> <span class="kw">blbcoef</span>(fit), <span class="dt">sigma =</span> <span class="kw">blbsigma</span>(fit))</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">}</a></code></pre></div>
<p>As we can see here, we use the mutinominal distribution to decide the weights for each fit and pass to the lm function. The reason we use weight fit is to prevent the different covariance matrix which is required by ordinary fitting.</p>
</div>
<div id="glm-ftting" class="section level3">
<h3>glm ftting</h3>
<p>For glm, as the user may want to assign the family used for the fitting, a slight modification happened to allow user to pass the family to the bottom level. The user now can assign the family model they want and it will pass by functions to the glm model at the bottom level</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">blbglm_prallel &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, <span class="dt">family =</span> <span class="st">'gaussian'</span>, <span class="dt">m =</span> <span class="dv">10</span>, <span class="dt">B =</span> <span class="dv">5000</span>, <span class="dt">core =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(core)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="kw">clusterExport</span>(cl, <span class="kw">c</span>(<span class="st">&quot;glm_each_boot&quot;</span>,<span class="st">&quot;glm_base&quot;</span>,<span class="st">&quot;blbcoef&quot;</span>,<span class="st">&quot;blbsigma&quot;</span>))</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="cf">if</span>(<span class="kw">typeof</span>(data) <span class="op">==</span><span class="st"> &quot;character&quot;</span>){</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">    df &lt;-<span class="st"> </span><span class="kw">read_list</span>(data)</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">    data_list &lt;-<span class="st"> </span><span class="kw">split_data</span>(df, m)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  }</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  <span class="cf">else</span>{</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">    data_list &lt;-<span class="st"> </span><span class="kw">split_data</span>(data, m)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">  estimates &lt;-<span class="st"> </span><span class="kw">parLapplyLB</span>(cl,</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">                           data_list,</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">                           <span class="dt">chunk.size =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">                           glm_each_subsample,<span class="dt">formula =</span> formula, <span class="dt">family =</span> family, <span class="dt">n =</span> <span class="kw">nrow</span>(data), <span class="dt">B =</span> B)</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">  <span class="kw">stopCluster</span>(cl)</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">  res &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">estimates =</span> estimates, <span class="dt">formula =</span> formula)</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">  <span class="kw">class</span>(res) &lt;-<span class="st"> &quot;blblm&quot;</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">  <span class="kw">invisible</span>(res)</a>
<a class="sourceLine" id="cb9-19" data-line-number="19">}</a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="co"># Bottom level</span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21">glm_base &lt;-<span class="st"> </span><span class="cf">function</span>(formula, family, data, freqs) {</a>
<a class="sourceLine" id="cb9-22" data-line-number="22">  <span class="co"># drop the original closure of formula,</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23">  <span class="co"># otherwise the formula will pick a wront variable from the global scope.</span></a>
<a class="sourceLine" id="cb9-24" data-line-number="24">  <span class="kw">environment</span>(formula) &lt;-<span class="st"> </span><span class="kw">environment</span>()</a>
<a class="sourceLine" id="cb9-25" data-line-number="25">  fit &lt;-<span class="st"> </span><span class="kw">glm</span>(formula, <span class="dt">family =</span> family, data, <span class="dt">weights =</span> freqs)</a>
<a class="sourceLine" id="cb9-26" data-line-number="26">  <span class="kw">list</span>(<span class="dt">coef =</span> <span class="kw">blbcoef</span>(fit), <span class="dt">sigma =</span> <span class="kw">blbsigma</span>(fit))</a>
<a class="sourceLine" id="cb9-27" data-line-number="27"> }</a></code></pre></div>
</div>
</div>
<div id="summarizing-the-statistics-and-other-functions" class="section level2">
<h2>Summarizing the statistics and other functions</h2>
<div id="computing-and-summarizing-the-statistics-for-each-boot" class="section level3">
<h3>Computing and Summarizing the statistics for each boot</h3>
<p>However, one may well notices that there is certain functions at the very bottom level of each model such as <code>blbcoef</code>, <code>sigma</code> etc. Those are the functions that we would like to use to acquire the coefficiences of each fitting. Those functions records the coefficiences at the bottom levels and return in the form of the list. Then at a higher level, the list is reduced through <code>map_reduce</code> function and then stored up. Allowing user to use functions to access. The technique details are bellow.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">mean_lwr_upr &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">level =</span> <span class="fl">0.95</span>) {</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  alpha &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>level</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  <span class="kw">c</span>(<span class="dt">fit =</span> <span class="kw">mean</span>(x), <span class="kw">quantile</span>(x, <span class="kw">c</span>(alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(<span class="kw">c</span>(<span class="st">&quot;lwr&quot;</span>, <span class="st">&quot;upr&quot;</span>)))</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">map_mean &lt;-<span class="st"> </span><span class="cf">function</span>(.x, .f, ...) {</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  (<span class="kw">map</span>(.x, .f, ...) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(<span class="st">`</span><span class="dt">+</span><span class="st">`</span>)) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(.x)</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb10-9" data-line-number="9"></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">map_cbind &lt;-<span class="st"> </span><span class="cf">function</span>(.x, .f, ...) {</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">  <span class="kw">map</span>(.x, .f, ...) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(cbind)</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb10-13" data-line-number="13"></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">map_rbind &lt;-<span class="st"> </span><span class="cf">function</span>(.x, .f, ...) {</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">  <span class="kw">map</span>(.x, .f, ...) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(rbind)</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">}</a></code></pre></div>
</div>
<div id="statistics-user-can-acess" class="section level3">
<h3>Statistics user can acess</h3>
<p>There are mainly two set of parameters user can access at the top level after the fitting. The first set is the coefficiences (in average form) of each subsample. The second is the sigma, in average form of each model. There acquire through follow functions. For several of the them, user can have the confidence interval than mere parameter.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">sigma.blblm &lt;-<span class="st"> </span><span class="cf">function</span>(object, <span class="dt">confidence =</span> <span class="ot">FALSE</span>, <span class="dt">level =</span> <span class="fl">0.95</span>, ...) {</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  est &lt;-<span class="st"> </span>object<span class="op">$</span>estimates</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  sigma &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">map_dbl</span>(est, <span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(<span class="kw">map_dbl</span>(., <span class="st">&quot;sigma&quot;</span>))))</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="cf">if</span> (confidence) {</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">    alpha &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.95</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">    limits &lt;-<span class="st"> </span>est <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="st">      </span><span class="kw">map_mean</span>(<span class="op">~</span><span class="st"> </span><span class="kw">quantile</span>(<span class="kw">map_dbl</span>(., <span class="st">&quot;sigma&quot;</span>), <span class="kw">c</span>(alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="st">      </span><span class="kw">set_names</span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">    <span class="kw">return</span>(<span class="kw">c</span>(<span class="dt">sigma =</span> sigma, <span class="dt">lwr =</span> limits[<span class="dv">1</span>], <span class="dt">upr =</span> limits[<span class="dv">2</span>]))</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">    <span class="kw">return</span>(sigma)</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">  }</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb11-15" data-line-number="15">coef.blblm &lt;-<span class="st"> </span><span class="cf">function</span>(object, ...) {</a>
<a class="sourceLine" id="cb11-16" data-line-number="16">  est &lt;-<span class="st"> </span>object<span class="op">$</span>estimates</a>
<a class="sourceLine" id="cb11-17" data-line-number="17">  <span class="kw">map_mean</span>(est, <span class="op">~</span><span class="st"> </span><span class="kw">map_cbind</span>(., <span class="st">&quot;coef&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rowMeans</span>())</a>
<a class="sourceLine" id="cb11-18" data-line-number="18">}</a>
<a class="sourceLine" id="cb11-19" data-line-number="19"></a>
<a class="sourceLine" id="cb11-20" data-line-number="20">confint.blblm &lt;-<span class="st"> </span><span class="cf">function</span>(object, <span class="dt">parm =</span> <span class="ot">NULL</span>, <span class="dt">level =</span> <span class="fl">0.95</span>, ...) {</a>
<a class="sourceLine" id="cb11-21" data-line-number="21">  <span class="cf">if</span> (<span class="kw">is.null</span>(parm)) {</a>
<a class="sourceLine" id="cb11-22" data-line-number="22">    parm &lt;-<span class="st"> </span><span class="kw">attr</span>(<span class="kw">terms</span>(fit<span class="op">$</span>formula), <span class="st">&quot;term.labels&quot;</span>)</a>
<a class="sourceLine" id="cb11-23" data-line-number="23">  }</a>
<a class="sourceLine" id="cb11-24" data-line-number="24">  alpha &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>level</a>
<a class="sourceLine" id="cb11-25" data-line-number="25">  est &lt;-<span class="st"> </span>object<span class="op">$</span>estimates</a>
<a class="sourceLine" id="cb11-26" data-line-number="26">  out &lt;-<span class="st"> </span><span class="kw">map_rbind</span>(parm, <span class="cf">function</span>(p) {</a>
<a class="sourceLine" id="cb11-27" data-line-number="27">    <span class="kw">map_mean</span>(est, <span class="op">~</span><span class="st"> </span><span class="kw">map_dbl</span>(., <span class="kw">list</span>(<span class="st">&quot;coef&quot;</span>, p)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">quantile</span>(<span class="kw">c</span>(alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>alpha <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb11-28" data-line-number="28">  })</a>
<a class="sourceLine" id="cb11-29" data-line-number="29">  <span class="cf">if</span> (<span class="kw">is.vector</span>(out)) {</a>
<a class="sourceLine" id="cb11-30" data-line-number="30">    out &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">t</span>(out))</a>
<a class="sourceLine" id="cb11-31" data-line-number="31">  }</a>
<a class="sourceLine" id="cb11-32" data-line-number="32">  <span class="kw">dimnames</span>(out)[[<span class="dv">1</span>]] &lt;-<span class="st"> </span>parm</a>
<a class="sourceLine" id="cb11-33" data-line-number="33">  out</a>
<a class="sourceLine" id="cb11-34" data-line-number="34">}</a></code></pre></div>
</div>
<div id="prediction" class="section level3">
<h3>Prediction</h3>
<p>The user can input they new data and predict it using predict <code>function</code> also. The data will be convert to a design matrix and fit.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">predict.blblm &lt;-<span class="st"> </span><span class="cf">function</span>(object, new_data, <span class="dt">confidence =</span> <span class="ot">FALSE</span>, <span class="dt">level =</span> <span class="fl">0.95</span>,<span class="dt">core =</span> <span class="dv">1</span>, ...) {</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">  est &lt;-<span class="st"> </span>object<span class="op">$</span>estimates</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  X &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="kw">reformulate</span>(<span class="kw">attr</span>(<span class="kw">terms</span>(object<span class="op">$</span>formula), <span class="st">&quot;term.labels&quot;</span>)), new_data)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">  <span class="cf">if</span> (confidence) {</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">    <span class="kw">map_mean_parallel</span>(est, <span class="op">~</span><span class="st"> </span><span class="kw">map_cbind</span>(., <span class="op">~</span><span class="st"> </span>X <span class="op">%*%</span><span class="st"> </span>.<span class="op">$</span>coef) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="st">      </span><span class="kw">apply</span>(<span class="dv">1</span>, mean_lwr_upr, <span class="dt">level =</span> level) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">      </span><span class="kw">t</span>())</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">    <span class="kw">map_mean</span>(est, <span class="op">~</span><span class="st"> </span><span class="kw">map_cbind</span>(., <span class="op">~</span><span class="st"> </span>X <span class="op">%*%</span><span class="st"> </span>.<span class="op">$</span>coef) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rowMeans</span>())</a>
<a class="sourceLine" id="cb12-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">}</a></code></pre></div>
</div>
</div>
</div>
<div id="an-round-up-example-using-lm" class="section level1">
<h1>An round up example using lm</h1>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">fit &lt;-<span class="st"> </span><span class="kw">blblm</span>(mpg <span class="op">~</span><span class="st"> </span>wt <span class="op">*</span><span class="st"> </span>hp, <span class="dt">data =</span> mtcars, <span class="dt">m =</span> <span class="dv">3</span>, <span class="dt">B =</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw">coef</span>(fit)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#&gt; (Intercept)          wt          hp       wt:hp </span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; 50.64026853 -8.46005192 -0.13174859  0.03110961</span></a></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">confint</span>(fit, <span class="kw">c</span>(<span class="st">&quot;wt&quot;</span>, <span class="st">&quot;hp&quot;</span>))</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="co">#&gt;           2.5%       97.5%</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="co">#&gt; wt -10.3890190 -6.12925691</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co">#&gt; hp  -0.1813312 -0.08651781</span></a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">sigma</span>(fit)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="co">#&gt; [1] 1.451462</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="kw">sigma</span>(fit, <span class="dt">confidence =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co">#&gt;    sigma      lwr      upr </span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#&gt; 1.451462 1.170783 1.670883</span></a></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
